<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Vocabulary Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body { font-family: system-ui, Arial, sans-serif; background:#f5f7fb; margin:0; padding:20px; }
h1 { text-align:center; }
.card { background:#fff; border-radius:14px; padding:20px; max-width:820px; margin:0 auto 20px; box-shadow:0 10px 24px rgba(0,0,0,.08); }
label { font-weight:600; margin-top:12px; display:block; }
input, select { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; }
button { padding:14px 20px; border:none; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; }
.primary { background:#4f46e5; color:#fff; }
.secondary { background:#e5e7eb; }
.options button { display:block; width:100%; margin-top:10px; text-align:left; }
.options button.selected { background:#bfdbfe; }
.options button.correct { background:#dcfce7; }
.options button.incorrect { background:#fee2e2; }
.result { font-size:18px; text-align:center; }
</style>
</head>

<body>

<h1>üìù Vocabulary Test</h1>

<div class="card" id="config">
  <label>User (email)</label>
  <input id="user" placeholder="vd: sunny@gmail.com" />

  <label>T·ªïng s·ªë t·ª´ ki·ªÉm tra</label>
  <input type="number" id="total" value="10" min="1" />

  <label>C√°ch l·∫•y t·ª´</label>
  <select id="mode">
    <option value="recent">T·ª´ m·ªõi nh·∫•t</option>
    <option value="random">Ng·∫´u nhi√™n</option>
  </select>

  <label>Meaning / Listening</label>
  <input type="range" id="meaningCount" min="0" value="5" />
  <div id="sliderInfo"></div>

  <br>
  <button class="primary" onclick="startTest()">Start</button>
</div>

<div class="card" id="test" style="display:none"></div>
<div class="card" id="result" style="display:none"></div>

<script>
/* ================= GOOGLE SHEET ================= */
const SHEET_URL =
'https://docs.google.com/spreadsheets/d/1vmqYN5_0lku8q97oxQP3ppQLtSOxTZtL_L0fnAPnF2Y/edit';

function extractSheetId(url){
  const m = url.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  return m ? m[1] : null;
}

const sheetId = extractSheetId(SHEET_URL);
const apiURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

let WORDS = [];
let questions = [];
let answers = {};

async function loadWords(){
  const res = await fetch(apiURL + `&_ts=${Date.now()}`);
  const text = await res.text();
  const json = JSON.parse(text.substring(47, text.length - 2));

  WORDS = json.table.rows.map(r => ({
    time: r.c?.[0]?.v || '',
    owner: r.c?.[1]?.v || '',
    en: r.c?.[2]?.v || '',
    vi: r.c?.[3]?.v || ''
  })).filter(w => w.en && w.vi);
}

loadWords();

/* ================= UTIL ================= */
const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
const slider = document.getElementById('meaningCount');
const sliderInfo = document.getElementById('sliderInfo');

function updateSlider(){
  const total = +document.getElementById('total').value;
  slider.max = total;
  sliderInfo.innerText = `Meaning: ${slider.value} | Listening: ${total - slider.value}`;
}
slider.oninput = updateSlider;
document.getElementById('total').oninput = updateSlider;
updateSlider();

/* ================= TEST LOGIC ================= */
function startTest(){
  const user = document.getElementById('user').value.trim();
  const total = +document.getElementById('total').value;
  const meaningCount = +slider.value;
  const listeningCount = total - meaningCount;
  const mode = document.getElementById('mode').value;

  let pool = WORDS.filter(w => w.owner === 'All' || w.owner === user);

  if (mode === 'recent') {
    pool.sort((a,b) => new Date(b.time) - new Date(a.time));
  } else {
    pool = shuffle(pool);
  }

  pool = pool.slice(0, total);

  const meaning = shuffle(pool).slice(0, meaningCount);
  const listening = shuffle(pool).slice(0, listeningCount);

  questions = shuffle([
    ...meaning.map(w => makeMeaningQ(w, pool)),
    ...listening.map(w => makeListeningQ(w, pool))
  ]);

  document.getElementById('config').style.display = 'none';
  renderTest();
}

function makeMeaningQ(w, pool){
  const options = shuffle([
    w.vi,
    ...shuffle(pool.filter(x => x.vi !== w.vi)).slice(0,3).map(x => x.vi)
  ]);
  return { type:'meaning', q:w.en, options, answer:w.vi };
}

function makeListeningQ(w, pool){
  const options = shuffle([
    w.en,
    ...shuffle(pool.filter(x => x.en !== w.en)).slice(0,3).map(x => x.en)
  ]);
  return { type:'listening', q:w.en, options, answer:w.en };
}

function speak(text){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  speechSynthesis.speak(u);
}

function renderTest(){
  const box = document.getElementById('test');
  box.style.display = 'block';
  box.innerHTML = '<h2>Test</h2>';

  questions.forEach((q,i)=>{
    const div = document.createElement('div');
    div.innerHTML = `<b>${i+1}. ${q.type==='meaning'?q.q:'Listening'}</b>`;
    if(q.type==='listening'){
      div.innerHTML += ` <button onclick="speak('${q.q}')">üîä</button>`;
    }

    const opt = document.createElement('div');
    opt.className = 'options';

    q.options.forEach(o=>{
      const b = document.createElement('button');
      b.className='secondary';
      b.innerText=o;
      b.onclick=()=>{
        opt.querySelectorAll('button').forEach(x=>x.classList.remove('selected'));
        b.classList.add('selected');
        answers[i]=o;
      };
      opt.appendChild(b);
    });

    div.appendChild(opt);
    box.appendChild(div);
  });

  const submit = document.createElement('button');
  submit.className='primary';
  submit.innerText='Submit';
  submit.style.marginTop='20px';
  submit.onclick=submitTest;
  box.appendChild(submit);
}

function submitTest(){
  let correct=0;
  const blocks=document.querySelectorAll('.options');

  questions.forEach((q,i)=>{
    const btns=blocks[i].querySelectorAll('button');
    btns.forEach(b=>{
      if(b.innerText===q.answer) b.classList.add('correct');
      if(b.classList.contains('selected') && b.innerText!==q.answer){
        b.classList.add('incorrect');
      }
    });
    if(answers[i]===q.answer) correct++;
  });

  const percent=Math.round(correct/questions.length*100);
  let msg='C·∫ßn c·ªë g·∫Øng th√™m';
  if(percent>=90) msg='B·∫°n l√†m r·∫•t t·ªët üåü';
  else if(percent>=75) msg='R·∫•t kh√° üëç';
  else if(percent>=60) msg='·ªîn nh∆∞ng c·∫ßn luy·ªán th√™m';

  const r=document.getElementById('result');
  r.style.display='block';
  r.innerHTML=`<h2>K·∫øt qu·∫£</h2><p>${correct}/${questions.length} (${percent}%)</p><p>${msg}</p>`;
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Vocabulary Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{
      font-family:system-ui,Arial,sans-serif;
      background:linear-gradient(135deg,#eef2ff,#fdf4ff);
      margin:0;padding:20px;
    }
    h1{text-align:center;margin-bottom:20px}

    .card{
      background:#0f172a;color:#e5e7eb;
      border-radius:20px;
      padding:24px 26px 30px;
      max-width:620px;
      margin:0 auto 24px;
      box-shadow:0 16px 40px rgba(0,0,0,.45);
      animation:fadeIn .4s ease;
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1}}

    label{font-weight:600;display:block;margin-top:14px;color:#c7d2fe}
    input,select{
      width:100%;padding:12px;margin-top:6px;
      border-radius:10px;border:1px solid #334155;
      font-size:15px;box-sizing:border-box;
      background:#1e293b;color:#e5e7eb;
    }

    button{
      display:flex;align-items:center;justify-content:center;gap:10px;
      padding:14px 22px;border:none;border-radius:14px;
      font-size:16px;font-weight:700;cursor:pointer;
      transition:all .25s ease;
    }
    button.primary{
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      color:#fff;box-shadow:0 10px 22px rgba(99,102,241,.4);
    }
    button.primary:hover{
      transform:translateY(-2px) scale(1.03);
      box-shadow:0 14px 30px rgba(99,102,241,.55);
    }
    button.secondary{background:#f3f4f6;color:#111827}
    button.secondary:hover{background:#e5e7eb}
    button:disabled{opacity:.6;cursor:not-allowed}

    .question{
      margin-top:20px;padding:18px;
      border-radius:14px;background:#fafafa;color:#111827;
      border:1px solid #e5e7eb;
    }
    .question b{color:#4338ca}

    .listen-btn{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#fff;border:none;
      padding:8px 14px;border-radius:999px;
      font-size:14px;font-weight:700;
      cursor:pointer;display:inline-flex;align-items:center;gap:6px;
      box-shadow:0 6px 16px rgba(34,197,94,.45);
    }

    .options button{width:100%;text-align:left;margin-top:8px}
    .options button.selected{outline:3px solid #6366f1;background:#eef2ff}
    .options button.correct{background:#dcfce7}
    .options button.incorrect{background:#fee2e2}

    .answer-correct{margin-top:8px;font-size:14px;color:#16a34a;font-weight:600}
    .error{color:#b91c1c;font-weight:700;text-align:center}
    .result-icon{
      margin-top:10px;
      font-size:22px;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .result-icon.correct{color:#16a34a;}
    .result-icon.incorrect{color:#dc2626;}

  </style>
</head>
<body>

<h1>üß† Vocabulary Test</h1>

<div class="card" id="config">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
    <div>
      <label>User</label>
      <input id="user" placeholder="VD: Sunny ho·∫∑c Rainy" />
    </div>
    <div>
      <label>T·ªïng s·ªë t·ª´ ki·ªÉm tra</label>
      <input type="number" id="total" value="10" min="1" />
    </div>

    <div>
      <label>Ph·∫°m vi t·ª´ card s·ªë:</label>
      <input type="number" id="startRow" value="2" min="2" />
    </div>
    <div>
      <label>ƒë·∫øn card s·ªë:</label>
      <input type="number" id="endRow" value="1000" min="2" />
    </div>

    <div style="grid-column:1/3">
      <label>C√°ch l·∫•y t·ª´</label>
      <select id="mode">
        <option value="recent">T·ª´ m·ªõi nh·∫•t</option>
        <option value="random">Ng·∫´u nhi√™n</option>
      </select>
    </div>

  </div>

  <label>Ph√¢n b·ªë c√¢u h·ªèi</label>
  <input type="range" id="meaningCount" min="0" value="50" max="100" />
  <div id="sliderInfo"></div>

  <div style="display:flex;justify-content:center;margin-top:28px">
    <button class="primary" style="width:260px;font-size:18px" onclick="startTest()">üöÄ B·∫Øt ƒë·∫ßu l√†m b√†i</button>
  </div>
  <p class="error" id="errorMsg"></p>
</div>

<div class="card" id="test" style="display:none"></div>
<div class="card" id="result" style="display:none"></div>

<script>

const API_URL = 'https://script.google.com/macros/s/AKfycbxFwY9moTt7fMEa2JEeNe2RUQgDeg7sXGxLWD4qvDGNkSJ-dh1Ab-G4vsMOSk9r0twK/exec';

let VOICES = [];

speechSynthesis.onvoiceschanged = () => {
  VOICES = speechSynthesis.getVoices();
};


function normalizeAnswer(text){
  if (!text) return '';
  return text
    .toString()
    .trim()
    .toLowerCase()
    .replace(/[.,!?;]/g,'')
    .replace(/\s+/g,' ');
}




let WORDS=[],questions=[],answers={};

const userInput=document.getElementById('user');
const totalInput=document.getElementById('total');
const startRowInput=document.getElementById('startRow');
const endRowInput=document.getElementById('endRow');
const modeSelect=document.getElementById('mode');
const slider=document.getElementById('meaningCount');
const sliderInfo=document.getElementById('sliderInfo');
const errorMsg=document.getElementById('errorMsg');
const config=document.getElementById('config');
const test=document.getElementById('test');
const result=document.getElementById('result');

function updateSlider(){
  // const total=+totalInput.value||0;
  // slider.max=total;
  // if(+slider.value>total) slider.value=total;
  sliderInfo.innerText=`Meaning: ${slider.value}% | Listening: ${100-slider.value}%`;
}
slider.oninput=updateSlider;
totalInput.oninput=updateSlider;
updateSlider();

const shuffle=a=>[...a].sort(()=>Math.random()-0.5);

async function loadWords(user, total, mode, start, end) {

  const url =
    `${API_URL}?owner=${encodeURIComponent(user)}` +
    `&limit=${total}` +
    `&mode=${mode}` +
    `&startRow=${start}` + 
    `&endRow=${end}`;

  const res = await fetch(url);
  if (!res.ok) throw new Error('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server');

  const json = await res.json();
  if (!json.success) throw new Error(json.error);

  WORDS = json.data;
}




async function startTest(){
  errorMsg.innerText='';

  const user = userInput.value.trim() || 'All';
  const total=+totalInput.value;
  const startRowValue=+startRow.value;
  const endRowValue=+endRow.value;
  const mode=modeSelect.value;

  errorMsg.innerText='‚è≥ ƒêang t·∫£i d·ªØ li·ªáu. Vui l√≤ng ch·ªù...';
  try {
    await loadWords(user, total, mode, startRowValue, endRowValue);
  } catch(e){
    errorMsg.innerText='‚ùå L·ªói t·∫£i d·ªØ li·ªáu: ' + e.message;
    return;
  }

  if(!WORDS.length){errorMsg.innerText='‚ùå Kh√¥ng c√≥ t·ª´ n√†o';return;}

  restartTest();
  renderTest();
}

function restartTest (){
  let pool = [...WORDS]; //already filtered at server side

  const meaningCount =  ((+slider.value) * pool.length)/100;
  const listeningCount = pool.length - meaningCount;

  pool = shuffle(pool);

  const meaningQs = pool
    .slice(0, meaningCount)
    .map(w => makeMeaningQ(w, pool));

  const listeningQs = pool
    .slice(meaningCount, pool.length)
    .map(w => makeListeningQ(w, pool));

  questions = shuffle([...meaningQs, ...listeningQs]);

  config.style.display='none';
  result.style.display = 'none';

  renderTest();

  window.scrollTo({top:0,behavior:'smooth'});
}
function makeMeaningQ(w, pool){
  const type = shuffle([
    'mc-en-vi',
    'mc-vi-en',
    'input-vi-en'
  ])[0];

  //alert(w.en);

  if(type === 'mc-en-vi'){
    let opt = shuffle([w.vi, ...shuffle([...pool.filter(x => normalizeAnswer(x.vi) !== normalizeAnswer(w.vi)).map(x => x.vi)]).slice(0, 3)]);
    const lack = 4 - opt.length;
    if(lack > 0) {
      const backupVI = shuffle(["Th√¥ng tin", "Th∆∞ vi·ªán", "V≈© tr·ª•", "Kinh nghi·ªám", "Ki·∫øn th·ª©c", "C·∫£i thi·ªán", "Th·∫•u hi·ªÉu", "S√°ng t·∫°o", "Tin t∆∞·ªüng", "Ph√°t tri·ªÉn", "Kh√°c bi·ªát", "Quan tr·ªçng", "Xu·∫•t s·∫Øc", "T·ª± nhi√™n", "S√°ng t·∫°o","Nhanh ch√≥ng", "C·∫©n th·∫≠n", "Th∆∞·ªùng xuy√™n", "D·ªÖ d√†ng", "Ho√†n h·∫£o"].filter(b =>  normalizeAnswer(b) !== normalizeAnswer(w.vi) && !pool.some(p => normalizeAnswer(p.vi) === normalizeAnswer(b))));
      opt = shuffle([...opt,...backupVI.slice(0,lack)]);
    }
  

    return {
      type:'meaning',
      subtype:type,
      prompt:w.en,
      answer:w.vi,
      // options:shuffle([w.vi,...shuffle(pool.filter(x=>x.vi!==w.vi)).slice(0,3).map(x=>x.vi)])
      options: opt
    };
  }

  if(type === 'mc-vi-en'){
    let opt = shuffle([w.en, ...shuffle([...pool.filter(x => normalizeAnswer(x.en) !== normalizeAnswer(w.en)).map(x => x.en)]).slice(0, 3)]);
    const lack = 4 - opt.length;
    if(lack > 0) {
      const backupEN = shuffle(["Information", "Library", "Universe", "Experience", "Knowledge","Improve", "Understand", "Create", "Believe", "Develop","Different", "Important", "Excellent", "Natural", "Creative","Quickly", "Carefully", "Usually", "Easily", "Perfectly"].filter(b =>  normalizeAnswer(b) !== normalizeAnswer(w.en) && !pool.some(p => normalizeAnswer(p.en) === normalizeAnswer(b))));
      opt = shuffle([...opt,...backupEN.slice(0,lack)]);
    }

    return {
      type:'meaning',
      subtype:type,
      prompt:w.vi,
      answer:w.en,
      //options:shuffle([w.en,...shuffle(pool.filter(x=>x.en!==w.en)).slice(0,3).map(x=>x.en)])
      options: opt
    };
  }

  // input Vietnamese ‚Üí English
  return {
    type:'meaning',
    subtype:type,
    prompt:w.vi,
    answer:w.en
  };
}


function makeListeningQ(w, pool){
  const type = shuffle([
    'listen-mc-en',
    //'listen-input-vi-en',  //temporary comment to pass speak Vietnamese on iOS
    'listen-input-en-en'
  ])[0];

  if(type === 'listen-mc-en'){
    return {
      type:'listening',
      subtype:type,
      audio:w.en,
      answer:w.en,
      options:shuffle([w.en,...shuffle(pool.filter(x=>x.en!==w.en)).slice(0,3).map(x=>x.en)])
    };
  }

  //temporary comment to pass speak Vietnamese on iOS
  // if(type === 'listen-input-vi-en'){
  //     return {
  //       type:'listening',
  //       subtype:type,
  //       audio:w.vi,
  //       answer:w.en
  //     };
  // }

  return {
    type:'listening',
    subtype:type,
    audio:w.en,
    answer:w.en
  };
}

const TTS_API = 'https://script.google.com/macros/s/AKfycbwm-urmD36iAE_65nzswGOdrvLnjIaQEiQ1Sr72QmIkx_EitYJ7JZxE84T6y8pOOl0wkQ/exec';

function isIOS() {
  return (
    /iPad|iPhone|iPod/.test(navigator.userAgent) ||
    (
      navigator.platform === 'MacIntel' &&
      navigator.maxTouchPoints > 1
    )
  );
}

async function playTTS(text, lang='vi') {
  const res = await fetch(`${API_URL}?text=${encodeURIComponent(text)}&lang=${lang}`);
  const json = await res.json();

  if (!json.success) throw json.error;

  const audio = new Audio(`data:${json.mime};base64,${json.base64}`);
  await audio.play();
}

  
function speak(text, lang = 'en') {
  if (!text) return;

  if (isIOS() && lang.startsWith('vi')) {
    playTTS(text, 'vi');
    return;
  }

  const u = new SpeechSynthesisUtterance(text);

  // map lang ƒë∆°n gi·∫£n ‚Üí chu·∫©n browser
  const langMap = {
    en: 'en-US',
    vi: 'vi-VN'
  };

  const finalLang = langMap[lang] || 'en-US';
  u.lang = finalLang;

  // ch·ªçn voice ƒë√∫ng ng√¥n ng·ªØ
  const voice = VOICES.find(v => v.lang === finalLang);
  if (voice) u.voice = voice;

  // c·∫•u h√¨nh ƒë·ªçc
  u.rate = lang === 'vi' ? 1.0 : 1.0;
  u.pitch = 1;

  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}


function renderTest(){
  test.style.display='block';
  test.innerHTML='<h2>Test</h2>';

  questions.forEach((q,i)=>{
    const div=document.createElement('div');
    div.className='question';

   let lang = 'en';
    if (q.type === 'listening') {
      if (q.subtype === 'listen-input-vi-en') {
        lang = 'vi';
      }
    }
    div.innerHTML= q.type==='meaning' ? `<b>${i+1}. ${q.prompt}</b>`: `<b>${i+1}. Listening</b> <button class="listen-btn" onclick="speak('${q.audio}', '${lang}')">üîä Nghe</button>`;

    if(q.options){
      const opt=document.createElement('div');
      opt.className='options';

      q.options.forEach(o=>{
        const b=document.createElement('button');
        b.className='secondary';
        b.innerText=o;
        b.onclick=()=>{
          opt.querySelectorAll('button').forEach(x=>x.classList.remove('selected'));
          b.classList.add('selected');
          answers[i]=o;
        };
        opt.appendChild(b);
      });
      div.appendChild(opt);
    } else {
      const input = document.createElement('input');
      input.placeholder = 'Nh·∫≠p ƒë√°p √°n...';

      input.oninput = () => {
        answers[i] = input.value;
      };

      div.appendChild(input);
    }

    test.appendChild(div);
  });

  const submit=document.createElement('button');
  submit.className='primary';
  submit.style.marginTop='24px';
  submit.innerHTML='‚úÖ N·ªôp b√†i';
  submit.onclick=submitTest;
  test.appendChild(submit);
}

function submitTest(){
  let correct = 0;

  document.querySelectorAll('.question').forEach((div, i) => {
    const q = questions[i];
    const userAns = answers[i];
    let isCorrect = false;

    // ===== TR·∫ÆC NGHI·ªÜM =====
    if (q.options) {
      div.querySelectorAll('button.secondary').forEach(b => {
        b.disabled = true;

        const text = b.innerText;
        if (text === q.answer) b.classList.add('correct');
        if (userAns === text && text !== q.answer) b.classList.add('incorrect');
      });

      if (userAns === q.answer) {
        correct++;
        isCorrect = true;
      } else {
        div.insertAdjacentHTML(
          'beforeend',
          `<div class="answer-correct">ƒê√°p √°n ƒë√∫ng: ${q.answer}</div>`
        );
      }
    }
    else {
      const input = div.querySelector('input');
      const userValue = input.value || '';
      const userNorm = normalizeAnswer(userValue);
      const correctNorm = normalizeAnswer(q.answer);

      // alert(q.answer);

      input.disabled = true;

      if (userNorm === correctNorm) {
        correct++;
        isCorrect = true;
        input.style.border = '2px solid #22c55e';
        input.style.background = '#dcfce7';
        input.style.color = '#166534';
      } else {
        input.style.border = '2px solid #ef4444';
        input.style.background = '#fee2e2';
        input.style.color = '#991b1b';

        div.insertAdjacentHTML(
          'beforeend',
          `<div class="answer-correct">ƒê√°p √°n ƒë√∫ng: ${q.answer}</div>`
        );
      }
    }


    // ===== ICON ‚úî / ‚úñ =====
    div.insertAdjacentHTML(
      'beforeend',
      isCorrect
        ? `<div class="result-icon correct">‚úî ƒê√∫ng</div>`
        : `<div class="result-icon incorrect">‚úñ Sai</div>`
    );
  });

  test.querySelector('button.primary').disabled = true;

  const percent = Math.round(correct / questions.length * 100);
  const msg =
    percent >= 90 ? 'üåü B·∫°n l√†m r·∫•t t·ªët!' :
    percent >= 75 ? 'üëç K·∫øt qu·∫£ r·∫•t kh√°' :
    percent >= 60 ? 'üôÇ ·ªîn, c·∫ßn luy·ªán th√™m' :
                    'üí™ C·ªë g·∫Øng th√™m nh√©';

  result.style.display = 'block';
  result.innerHTML = `
    <h2>K·∫øt qu·∫£</h2>
    <p>${correct}/${questions.length} (${percent}%)</p>
     <p>${msg}</p>
   <div style="display:flex;gap:12px;justify-content:center;margin-top:20px">
    <button class="primary" onclick="restartTest()">üîÑ L√†m l·∫°i</button>
    <button class="primary" onclick="location.reload()">‚öôÔ∏è T·∫°o m·ªõi</button>
    </div>    
  `;

  window.scroll(0, document.documentElement.scrollHeight);
}


</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Vocabulary Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      background: linear-gradient(135deg, #eef2ff, #fdf4ff);
      margin: 0; padding: 20px;
    }
    h1 { text-align:center; margin-bottom:20px; }
    .card {
      background:#fff;
      border-radius:18px;
      padding:24px;
      max-width:900px;
      margin:0 auto 24px;
      box-shadow:0 12px 30px rgba(0,0,0,.12);
      animation: fadeIn .4s ease;
    }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1} }

    label { font-weight:600; display:block; margin-top:14px; }
    input, select {
      width:100%; padding:12px; margin-top:6px;
      border-radius:10px; border:1px solid #ccc; font-size:15px;
    }

    button {
      padding:14px 20px; border:none; border-radius:12px;
      font-size:16px; font-weight:700; cursor:pointer;
      transition:.2s ease;
    }
    button.primary { background:#6366f1; color:#fff; }
    button.primary:hover { background:#4f46e5; }
    button.secondary { background:#e5e7eb; }
    button.secondary:hover { background:#d1d5db; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .question { margin-top:26px; }
    .options button {
      width:100%; text-align:left; margin-top:10px;
    }
    .options button.selected {
      outline:3px solid #6366f1;
      background:#eef2ff;
    }
    .options button.correct { background:#dcfce7; }
    .options button.incorrect { background:#fee2e2; }

    .answer-correct {
      margin-top:8px; font-size:14px; color:#16a34a; font-weight:600;
    }

    .result {
      text-align:center; font-size:18px;
    }
    .error {
      color:#b91c1c; font-weight:700; text-align:center;
    }
  </style>
</head>
<body>

<h1>üß† Vocabulary Test</h1>

<div class="card" id="config">
  <label>User</label>
  <input id="user" placeholder="VD: sunny@gmail.com" />

  <label>T·ªïng s·ªë t·ª´ ki·ªÉm tra</label>
  <input type="number" id="total" value="10" min="1" />

  <label>C√°ch l·∫•y t·ª´</label>
  <select id="mode">
    <option value="recent">T·ª´ m·ªõi nh·∫•t</option>
    <option value="random">Ng·∫´u nhi√™n</option>
  </select>

  <label>Ph√¢n b·ªë c√¢u h·ªèi</label>
  <input type="range" id="meaningCount" min="0" value="5" />
  <div id="sliderInfo"></div>

  <br />
  <button class="primary" onclick="startTest()">Start</button>
  <p class="error" id="errorMsg"></p>
</div>

<div class="card" id="test" style="display:none"></div>
<div class="card" id="result" style="display:none"></div>

<script>
/**************** CONFIG ****************/
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1vmqYN5_0lku8q97oxQP3ppQLtSOxTZtL_L0fnAPnF2Y/edit';

/**************** STATE ****************/
let WORDS = [];
let questions = [];
let answers = {};

const slider = document.getElementById('meaningCount');
const sliderInfo = document.getElementById('sliderInfo');

slider.oninput = updateSlider;
document.getElementById('total').oninput = updateSlider;

function updateSlider() {
  const total = +document.getElementById('total').value || 0;
  slider.max = total;
  if (+slider.value > total) slider.value = total;
  sliderInfo.innerText = `Meaning: ${slider.value} | Listening: ${total - slider.value}`;
}
updateSlider();

function shuffle(arr) {
  return [...arr].sort(() => Math.random() - 0.5);
}

/**************** DATA LOAD ****************/
async function loadWords() {
  const match = SHEET_URL.match(/spreadsheets\/d\/([^/]+)/);
  if (!match) throw new Error('Sheet URL kh√¥ng h·ª£p l·ªá');

  const sheetId = match[1];
  const gvizUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&_ts=${Date.now()}`;

  const res = await fetch(gvizUrl);
  const text = await res.text();
  const json = JSON.parse(text.substring(47, text.length - 2));

  WORDS = json.table.rows
    .map(r => ({
      time: r.c?.[0]?.v || '',
      owner: r.c?.[1]?.v || '',
      en: r.c?.[2]?.v || '',
      vi: r.c?.[3]?.v || ''
    }))
    .filter(w => w.en && w.vi);
}

/**************** START ****************/
async function startTest() {
  document.getElementById('errorMsg').innerText = '';
  await loadWords();

  const user = document.getElementById('user').value.trim();
  const total = +document.getElementById('total').value;
  const meaningCount = +slider.value;
  const mode = document.getElementById('mode').value;

  let pool = WORDS.filter(w => w.owner === 'All' || w.owner === user);

  if (pool.length === 0) {
    document.getElementById('errorMsg').innerText = '‚ùå Kh√¥ng c√≥ t·ª´ n√†o ƒë·ªÉ t·∫°o b√†i test';
    return;
  }

  if (mode === 'recent') pool.sort((a,b)=>new Date(b.time)-new Date(a.time));
  else pool = shuffle(pool);

  pool = pool.slice(0, total);

  if (pool.length === 0) {
    document.getElementById('errorMsg').innerText = '‚ùå Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ l√†m b√†i test';
    return;
  }

  const meaningWords = shuffle(pool).slice(0, meaningCount);
  const listeningWords = shuffle(pool).slice(0, total - meaningCount);

  questions = [
    ...meaningWords.map(w => createMeaningQ(w, pool)),
    ...listeningWords.map(w => createListeningQ(w, pool))
  ];

  questions = shuffle(questions);
  document.getElementById('config').style.display = 'none';
  renderTest();
}

function createMeaningQ(word, pool) {
  const options = shuffle([
    word.vi,
    ...shuffle(pool.filter(w => w.vi !== word.vi)).slice(0,3).map(w => w.vi)
  ]);
  return { type:'meaning', en:word.en, options, answer:word.vi };
}

function createListeningQ(word, pool) {
  const options = shuffle([
    word.en,
    ...shuffle(pool.filter(w => w.en !== word.en)).slice(0,3).map(w => w.en)
  ]);
  return { type:'listening', audio:word.en, options, answer:word.en };
}

function speak(text) {
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  speechSynthesis.speak(u);
}

/**************** RENDER ****************/
function renderTest() {
  const box = document.getElementById('test');
  box.style.display = 'block';
  box.innerHTML = '<h2>Test</h2>';

  questions.forEach((q,i) => {
    const div = document.createElement('div');
    div.className = 'question';

    div.innerHTML = q.type==='meaning'
      ? `<b>${i+1}. ${q.en}</b>`
      : `<b>${i+1}. Listening</b> <button onclick="speak('${q.audio}')">üîä</button>`;

    const optDiv = document.createElement('div');
    optDiv.className = 'options';

    q.options.forEach(opt => {
      const btn = document.createElement('button');
      btn.className = 'secondary';
      btn.innerText = opt;
      btn.onclick = () => {
        optDiv.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        answers[i] = opt;
      };
      optDiv.appendChild(btn);
    });

    div.appendChild(optDiv);
    box.appendChild(div);
  });

  const submit = document.createElement('button');
  submit.className = 'primary';
  submit.style.marginTop = '24px';
  submit.innerText = 'Submit';
  submit.onclick = submitTest;
  box.appendChild(submit);
}

/**************** SUBMIT ****************/
function submitTest() {
  const box = document.getElementById('test');
  const qs = box.querySelectorAll('.question');
  let correct = 0;

  qs.forEach((div,i) => {
    const q = questions[i];
    const btns = div.querySelectorAll('button.secondary');
    btns.forEach(b => {
      b.disabled = true;
      if (b.innerText === q.answer) b.classList.add('correct');
      if (answers[i] === b.innerText && b.innerText !== q.answer)
        b.classList.add('incorrect');
    });
    if (answers[i] === q.answer) correct++;

    if (answers[i] !== q.answer) {
      const c = document.createElement('div');
      c.className = 'answer-correct';
      c.innerText = `ƒê√°p √°n ƒë√∫ng: ${q.answer}`;
      div.appendChild(c);
    }
  });

  box.querySelector('button.primary').disabled = true;

  const percent = Math.round(correct / questions.length * 100);
  let msg = percent>=90?'üåü B·∫°n l√†m r·∫•t t·ªët!':percent>=75?'üëç K·∫øt qu·∫£ r·∫•t kh√°':percent>=60?'üôÇ ·ªîn, c·∫ßn luy·ªán th√™m':'üí™ C·ªë g·∫Øng th√™m nh√©';

  const r = document.getElementById('result');
  r.style.display = 'block';
  r.innerHTML = `<h2>K·∫øt qu·∫£</h2><p>${correct}/${questions.length} (${percent}%)</p><p>${msg}</p><button class="secondary" onclick="location.reload()">Test l·∫°i</button>`;
}
</script>

</body>
</html>
